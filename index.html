<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dark Horn Admin Panel</title>
  <style>
    /* Styling dasar panel admin */
    body {
      background: #121212;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
    }
    header, footer {
      background: #000;
      padding: 10px 20px;
      text-align: center;
    }
    h1 { margin: 0; }
    .container { max-width: 1000px; margin: 20px auto; }
    section {
      background: #1f1f1f;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    label, input, button, textarea, select {
      display: block;
      width: 100%;
      margin-bottom: 10px;
    }
    input, textarea, select {
      padding: 8px;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
    }
    button {
      background: #ff9800;
      border: none;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #e68900; }
    .editor-buttons { display: flex; gap: 10px; margin-bottom: 10px; }
    /* Progress Bar */
    #progressBarContainer {
      width: 100%;
      background: #333;
      border-radius: 5px;
      margin-top: 10px;
      position: relative;
      height: 25px;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff9800, #e68900);
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    #progressText {
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      line-height: 25px;
      font-size: 0.9rem;
    }
    /* File List Styling */
    .file-item {
      padding: 5px;
      border-bottom: 1px solid #444;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .file-item button {
      padding: 5px 10px;
      font-size: 0.8rem;
    }
    /* Folder Manager Section */
    .folder-manager { margin-top: 20px; }
    .folder-header { font-weight: bold; margin-bottom: 10px; }
  </style>
</head>
<body>
  <header>
    <h1>Dark Horn Admin Panel</h1>
  </header>
  <div class="container">
    <!-- Section 1: Setup Token -->
    <section id="tokenSection">
      <h2>Setup GitHub Token</h2>
      <form id="tokenForm">
        <label>Masukkan GitHub Token:</label>
        <input type="text" id="tokenInput" placeholder="Masukkan token di sini" required>
        <button type="submit">Simpan Token</button>
      </form>
      <div id="tokenStatus" class="status"></div>
    </section>
    
    <!-- Section 2: Edit Panel Code -->
    <section id="codeEditorSection">
      <h2>Edit Panel Code (Repository: panel)</h2>
      <label for="codeFileSelect">Pilih File:</label>
      <select id="codeFileSelect">
        <!-- Contoh file; Anda bisa menambahkan file lain -->
        <option value="index.html">index.html</option>
        <option value="panel.html">panel.html</option>
      </select>
      <button onclick="loadPanelCode()">Load File</button>
      <div class="editor-buttons">
        <button onclick="undoChange()">Undo</button>
        <button onclick="redoChange()">Redo</button>
        <button onclick="backupFile()">Backup Now</button>
      </div>
      <textarea id="codeEditor" rows="15" style="width:100%;">Content akan muncul di sini...</textarea>
      <div class="editor-buttons">
        <button onclick="savePanelCode()">Save Changes</button>
        <button onclick="deletePanelFile()">Delete File</button>
      </div>
      <div id="editorStatus" class="status"></div>
      <div id="progressBarContainer">
        <div id="progressBar"></div>
        <div id="progressText">0%</div>
      </div>
    </section>
    
    <!-- Section 3: File Manager untuk Repo Dark Horn -->
    <section id="fileManagerSection">
      <h2>File Manager (Repo: Dark Horn)</h2>
      <div id="folderList">Memuat folder...</div>
      <button onclick="refreshFolder()">Refresh Folder</button>
    </section>
    
  </div>
  <footer>
    <p>&copy; 2025 Dark Horn Admin Panel</p>
  </footer>
  
  <script>
    const OWNER_PANEL = "ScarilyId";
    const REPO_PANEL = "panel";
    const REPO_DARKHORN = "Darkhorn";
    let GITHUB_TOKEN = localStorage.getItem("GITHUB_TOKEN") || "";
    
    const tokenStatus = document.getElementById("tokenStatus");
    function updateTokenStatus() {
      tokenStatus.textContent = GITHUB_TOKEN ? "Token tersimpan." : "Token belum diset.";
    }
    updateTokenStatus();
    
    document.getElementById("tokenForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const tokenInput = document.getElementById("tokenInput").value.trim();
      if(tokenInput) {
        GITHUB_TOKEN = tokenInput;
        localStorage.setItem("GITHUB_TOKEN", tokenInput);
        updateTokenStatus();
        alert("Token berhasil disimpan!");
      }
    });
    
    // Fungsi untuk update progress bar (simulasi)
    function updateProgress(percent) {
      const bar = document.getElementById("progressBar");
      const text = document.getElementById("progressText");
      bar.style.width = percent + "%";
      text.textContent = percent + "%";
    }
    
    // Fungsi simulasi progress (misalnya, selama 3 detik)
    function simulateProgress(callback) {
      let percent = 0;
      updateProgress(percent);
      const interval = setInterval(() => {
        percent += 10;
        updateProgress(percent);
        if(percent >= 100) {
          clearInterval(interval);
          callback();
        }
      }, 300);
    }
    
    // Fungsi baca file sebagai Base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
    
    // Fungsi upload file dengan progress (menggunakan simulasi progress)
    async function uploadFile(repo, path, file, commitMessage) {
      if (!GITHUB_TOKEN) { alert("Token belum diset!"); return false; }
      if (!file) { alert("File tidak ditemukan."); return false; }
      document.getElementById("editorStatus").textContent = commitMessage + " sedang diupload...";
      return new Promise(async (resolve) => {
        simulateProgress(async () => {
          try {
            const content = await readFileAsBase64(file);
            const url = `https://api.github.com/repos/${repo}/${path}`;
            let sha = null;
            const getRes = await fetch(url, {
              headers: {
                "Authorization": "token " + GITHUB_TOKEN,
                "Accept": "application/vnd.github.v3+json"
              }
            });
            if(getRes.ok) {
              const data = await getRes.json();
              sha = data.sha;
            }
            const payload = {
              message: commitMessage,
              content: content,
              branch: "main"
            };
            if(sha) payload.sha = sha;
            const res = await fetch(url, {
              method: "PUT",
              headers: {
                "Authorization": "token " + GITHUB_TOKEN,
                "Content-Type": "application/json",
                "Accept": "application/vnd.github.v3+json"
              },
              body: JSON.stringify(payload)
            });
            if(res.ok) {
              document.getElementById("editorStatus").textContent = commitMessage + " berhasil.";
              updateProgress(0);
              resolve(true);
            } else {
              document.getElementById("editorStatus").textContent = commitMessage + " gagal.";
              console.error(await res.json());
              updateProgress(0);
              resolve(false);
            }
          } catch (error) {
            console.error(error);
            document.getElementById("editorStatus").textContent = "Error: " + error.message;
            updateProgress(0);
            resolve(false);
          }
        });
      });
    }
    
    // Fungsi untuk load kode dari repo panel
    async function loadPanelCode() {
      const fileSelect = document.getElementById("codeFileSelect");
      const filePath = fileSelect.value;
      if (!GITHUB_TOKEN) { alert("Token belum diset!"); return; }
      const url = `https://api.github.com/repos/${REPO_PANEL}/${filePath}`;
      document.getElementById("editorStatus").textContent = "Memuat file...";
      try {
        const res = await fetch(url, {
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        if(!res.ok) throw new Error("Gagal memuat file.");
        const data = await res.json();
        const content = atob(data.content);
        document.getElementById("codeEditor").value = content;
        document.getElementById("editorStatus").textContent = "File dimuat.";
        // Inisialisasi undo stack
        undoStack = [content];
        redoStack = [];
      } catch (error) {
        console.error(error);
        document.getElementById("editorStatus").textContent = error.message;
      }
    }
    
    // Fungsi untuk menyimpan kode panel ke repo panel
    async function savePanelCode() {
      const fileSelect = document.getElementById("codeFileSelect");
      const filePath = fileSelect.value;
      const newContent = document.getElementById("codeEditor").value;
      document.getElementById("editorStatus").textContent = "Menyimpan file...";
      simulateProgress(async () => {
        await updateFile(REPO_PANEL, filePath, newContent, "Update " + filePath, true);
      });
    }
    
    // Fungsi untuk update file (digunakan oleh editor)
    async function updateFile(repo, filePath, newText, commitMessage, replace = true) {
      if (!GITHUB_TOKEN) { alert("Token belum diset!"); return; }
      const url = `https://api.github.com/repos/${repo}/${filePath}`;
      try {
        const res = await fetch(url, {
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        let sha = null;
        let content = "";
        if (res.ok) {
          const data = await res.json();
          sha = data.sha;
          content = atob(data.content);
        }
        let updatedContent = replace ? newText : content + "\n" + newText;
        const payload = {
          message: commitMessage,
          content: btoa(updatedContent),
          branch: "main"
        };
        if(sha) payload.sha = sha;
        const putRes = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Content-Type": "application/json",
            "Accept": "application/vnd.github.v3+json"
          },
          body: JSON.stringify(payload)
        });
        if(putRes.ok) {
          document.getElementById("editorStatus").textContent = filePath + " berhasil diperbarui.";
        } else {
          document.getElementById("editorStatus").textContent = "Gagal memperbarui " + filePath;
          console.error(await putRes.json());
        }
      } catch (error) {
        console.error(error);
        document.getElementById("editorStatus").textContent = "Error: " + error.message;
      }
    }
    
    // Fungsi Undo/Redo Editor
    let undoStack = [];
    let redoStack = [];
    const fileContentEl = document.getElementById("codeEditor");
    fileContentEl.addEventListener("input", function() {
      const currentContent = fileContentEl.value;
      if(undoStack.length === 0 || undoStack[undoStack.length - 1] !== currentContent) {
        undoStack.push(currentContent);
        redoStack = [];
      }
    });
    function undoChange() {
      if(undoStack.length > 1) {
        redoStack.push(undoStack.pop());
        fileContentEl.value = undoStack[undoStack.length - 1];
      } else {
        alert("Tidak ada perubahan untuk di-undo.");
      }
    }
    function redoChange() {
      if(redoStack.length > 0) {
        const content = redoStack.pop();
        undoStack.push(content);
        fileContentEl.value = content;
      } else {
        alert("Tidak ada perubahan untuk di-redo.");
      }
    }
    
    // Fungsi Backup File (simpan salinan dengan nama backup_timestamp.txt)
    async function backupFile() {
      const fileSelect = document.getElementById("codeFileSelect");
      const filePath = fileSelect.value;
      const currentContent = fileContentEl.value;
      const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
      const backupPath = filePath.replace(/(\.[^.]*)$/, `_backup_${timestamp}$1`);
      await updateFile(REPO_PANEL, backupPath, currentContent, "Backup " + filePath, true);
      alert("Backup dibuat: " + backupPath);
    }
    
    // Fungsi Hapus File dari repo panel
    async function deletePanelFile() {
      const fileSelect = document.getElementById("codeFileSelect");
      const filePath = fileSelect.value;
      if(!confirm("Hapus file " + filePath + "?")) return;
      if (!GITHUB_TOKEN) { alert("Token belum diset!"); return; }
      const url = `https://api.github.com/repos/${REPO_PANEL}/${filePath}`;
      try {
        const res = await fetch(url, {
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        if(res.ok) {
          const data = await res.json();
          const sha = data.sha;
          const payload = {
            message: "Delete " + filePath,
            sha: sha,
            branch: "main"
          };
          const delRes = await fetch(url, {
            method: "DELETE",
            headers: {
              "Authorization": "token " + GITHUB_TOKEN,
              "Content-Type": "application/json",
              "Accept": "application/vnd.github.v3+json"
            },
            body: JSON.stringify(payload)
          });
          if(delRes.ok) {
            document.getElementById("editorStatus").textContent = filePath + " berhasil dihapus.";
          } else {
            document.getElementById("editorStatus").textContent = "Gagal menghapus " + filePath;
            console.error(await delRes.json());
          }
        } else {
          document.getElementById("editorStatus").textContent = "Gagal mengambil info file.";
        }
      } catch (error) {
        console.error(error);
        document.getElementById("editorStatus").textContent = "Error: " + error.message;
      }
    }
    
    // Fungsi File Manager untuk repo Dark Horn
    async function refreshFolder() {
      const folderListDiv = document.getElementById("folderList");
      folderListDiv.innerHTML = "Memuat folder...";
      try {
        const url = `https://api.github.com/repos/${REPO_DARKHORN}/contents/`;
        const res = await fetch(url, {
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        if(res.ok) {
          const files = await res.json();
          let listHtml = "";
          files.forEach(file => {
            listHtml += `<div class="file-item">
                           <span>${file.name}</span>
                           <button onclick="deleteFile('${file.path}', '${REPO_DARKHORN}')">Delete</button>
                         </div>`;
          });
          folderListDiv.innerHTML = listHtml;
        } else {
          folderListDiv.innerHTML = "Gagal memuat folder.";
        }
      } catch (error) {
        console.error(error);
        folderListDiv.innerHTML = "Error: " + error.message;
      }
    }
    
    async function deleteFile(filePath, repo) {
      if(!confirm("Hapus file " + filePath + "?")) return;
      if (!GITHUB_TOKEN) { alert("Token belum diset!"); return; }
      const url = `https://api.github.com/repos/${repo}/${filePath}`;
      try {
        const res = await fetch(url, {
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        if(res.ok) {
          const data = await res.json();
          const sha = data.sha;
          const payload = {
            message: "Delete " + filePath,
            sha: sha,
            branch: "main"
          };
          const delRes = await fetch(url, {
            method: "DELETE",
            headers: {
              "Authorization": "token " + GITHUB_TOKEN,
              "Content-Type": "application/json",
              "Accept": "application/vnd.github.v3+json"
            },
            body: JSON.stringify(payload)
          });
          if(delRes.ok) {
            alert(filePath + " berhasil dihapus.");
            refreshFolder();
          } else {
            alert("Gagal menghapus " + filePath);
            console.error(await delRes.json());
          }
        } else {
          alert("Gagal mengambil info file " + filePath);
        }
      } catch (error) {
        console.error(error);
        alert("Error: " + error.message);
      }
    }
    
    // Panggil fungsi inisialisasi secara paralel
    Promise.all([
      loadGallery(),
      fetchMembers(),
      fetchLogo(),
      fetchRecruitment(),
      fetchSkinsMapping(),
      refreshFolder()
    ]).catch(err => console.error("Error in initialization:", err));
  </script>
</body>
</html>
