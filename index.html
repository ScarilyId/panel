<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dark Horn Panel</title>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    .section {
      background: #1f1f1f;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    label, input, button, textarea {
      display: block;
      width: 100%;
      margin-bottom: 10px;
    }
    input, textarea {
      padding: 8px;
      border: none;
      border-radius: 4px;
    }
    button {
      background: #ff9800;
      border: none;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #e68900;
    }
    .status {
      margin-top: 10px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>Dark Horn Panel</h1>
  <div class="container">
    <!-- 1. Token Setup -->
    <div class="section" id="tokenSection">
      <h2>Setup GitHub Token</h2>
      <form id="tokenForm">
        <label>Masukkan GitHub Token:</label>
        <input type="text" id="tokenInput" placeholder="Masukkan token disini" required>
        <button type="submit">Simpan Token</button>
      </form>
      <div id="tokenStatus" class="status"></div>
    </div>
    
    <!-- 2. Upload Foto -->
    <div class="section">
      <h2>Upload Foto ke Repo Darkhorn</h2>
      <form id="uploadImageForm">
        <label>Pilih file image:</label>
        <input type="file" id="imageFile" accept="image/*" required>
        <button type="submit">Upload Image</button>
      </form>
      <div id="uploadImageStatus" class="status"></div>
    </div>
    
    <!-- 3. Edit Member List -->
    <div class="section">
      <h2>Edit Member List (member_list.txt)</h2>
      <form id="editMemberForm">
        <label>Masukkan data member baru (teks akan ditambahkan):</label>
        <textarea id="memberText" rows="4" placeholder="Masukkan data member..."></textarea>
        <button type="submit">Simpan Perubahan</button>
      </form>
      <div id="memberStatus" class="status"></div>
    </div>
    
    <!-- 4. Edit Comments -->
    <div class="section">
      <h2>Edit Comments (comments.txt)</h2>
      <form id="editCommentsForm">
        <label>Masukkan komentar baru (teks akan ditambahkan):</label>
        <textarea id="commentsText" rows="4" placeholder="Masukkan komentar..."></textarea>
        <button type="submit">Simpan Perubahan</button>
      </form>
      <div id="commentsStatus" class="status"></div>
    </div>
  </div>
  
  <script>
    // Global Variabel
    let GITHUB_TOKEN = localStorage.getItem("GITHUB_TOKEN") || "";
    const OWNER = "ScarilyId";
    const REPO = "Darkhorn";  // Semua operasi di repo "Darkhorn"
    
    const tokenStatus = document.getElementById("tokenStatus");
    function updateTokenStatus() {
      tokenStatus.textContent = GITHUB_TOKEN ? "Token tersimpan." : "Token belum diset.";
    }
    updateTokenStatus();
    
    // Simpan token ke localStorage
    document.getElementById("tokenForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const tokenInput = document.getElementById("tokenInput").value.trim();
      if(tokenInput) {
        GITHUB_TOKEN = tokenInput;
        localStorage.setItem("GITHUB_TOKEN", tokenInput);
        updateTokenStatus();
        alert("Token berhasil disimpan!");
      }
    });
    
    // Fungsi bantu: Membaca file dan mengubah ke Base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64String = reader.result.split(",")[1];
          resolve(base64String);
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
    
    // Fungsi bantu: Upload file ke GitHub
    async function uploadFileToGitHub(repo, path, file, commitMessage) {
      if(!GITHUB_TOKEN) {
        alert("Token GitHub belum diset!");
        return false;
      }
      try {
        const content = await readFileAsBase64(file);
        const url = `https://api.github.com/repos/${OWNER}/${repo}/contents/${path}`;
        let sha = null;
        let getResponse = await fetch(url, {
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        if(getResponse.ok) {
          const getData = await getResponse.json();
          sha = getData.sha;
        }
        const payload = {
          message: commitMessage,
          content: content,
          branch: "main"
        };
        if(sha) payload.sha = sha;
        const response = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Content-Type": "application/json",
            "Accept": "application/vnd.github.v3+json"
          },
          body: JSON.stringify(payload)
        });
        if(response.ok) {
          return true;
        } else {
          console.error(await response.json());
          return false;
        }
      } catch(error) {
        console.error(error);
        return false;
      }
    }
    
    // 2. Upload Image (foto) ke repo Darkhorn di folder "images/"
    document.getElementById("uploadImageForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const fileInput = document.getElementById("imageFile");
      const file = fileInput.files[0];
      const statusDiv = document.getElementById("uploadImageStatus");
      if(file) {
        statusDiv.textContent = "Uploading image...";
        const path = "images/" + file.name;
        const success = await uploadFileToGitHub(REPO, path, file, "Upload image " + file.name);
        statusDiv.textContent = success ? "Image berhasil diupload." : "Gagal upload image.";
        fileInput.value = "";
      }
    });
    
    // Fungsi untuk mengupdate file teks di GitHub (untuk member_list.txt dan comments.txt)
    async function updateTextFile(filePath, newText, statusElement) {
      if(!GITHUB_TOKEN) {
        statusElement.textContent = "Token GitHub belum diset!";
        return;
      }
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`;
      let sha = null;
      let existingContent = "";
      statusElement.textContent = "Mengambil konten file...";
      try {
        let getResponse = await fetch(url, {
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        if(getResponse.ok) {
          const data = await getResponse.json();
          sha = data.sha;
          existingContent = atob(data.content);
        }
        // Menggabungkan teks baru dengan konten yang sudah ada (atau bisa disesuaikan logikanya)
        const updatedContent = existingContent + "\n" + newText;
        const payload = {
          message: "Update " + filePath,
          content: btoa(updatedContent),
          branch: "main"
        };
        if(sha) payload.sha = sha;
        statusElement.textContent = "Mengupdate file...";
        const response = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Content-Type": "application/json",
            "Accept": "application/vnd.github.v3+json"
          },
          body: JSON.stringify(payload)
        });
        if(response.ok) {
          statusElement.textContent = filePath + " berhasil diperbarui.";
        } else {
          statusElement.textContent = "Gagal memperbarui " + filePath;
          console.error(await response.json());
        }
      } catch (error) {
        console.error(error);
        statusElement.textContent = "Error: " + error.message;
      }
    }
    
    // 3. Edit Member List (member_list.txt)
    document.getElementById("editMemberForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const newData = document.getElementById("memberText").value;
      const statusDiv = document.getElementById("memberStatus");
      if(newData.trim() === "") {
        statusDiv.textContent = "Teks tidak boleh kosong.";
        return;
      }
      await updateTextFile("member_list.txt", newData, statusDiv);
      document.getElementById("memberText").value = "";
    });
    
    // 4. Edit Comments (comments.txt)
    document.getElementById("editCommentsForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const newData = document.getElementById("commentsText").value;
      const statusDiv = document.getElementById("commentsStatus");
      if(newData.trim() === "") {
        statusDiv.textContent = "Teks tidak boleh kosong.";
        return;
      }
      await updateTextFile("comments.txt", newData, statusDiv);
      document.getElementById("commentsText").value = "";
    });
  </script>
</body>
</html>
