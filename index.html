<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dark Horn Panel</title>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      margin: 0;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .section {
      background: #1f1f1f;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    label, input, button, textarea {
      display: block;
      width: 100%;
      margin-bottom: 10px;
    }
    input, textarea {
      padding: 8px;
      border: none;
      border-radius: 4px;
    }
    button {
      background: #ff9800;
      border: none;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #e68900;
    }
    .status {
      margin-top: 10px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>Dark Horn Panel</h1>
  <div class="container">
    <!-- 1. Setup Token -->
    <div class="section" id="tokenSection">
      <h2>Setup GitHub Token</h2>
      <form id="tokenForm">
        <label>Masukkan GitHub Token:</label>
        <input type="text" id="tokenInput" placeholder="Masukkan token disini" required>
        <button type="submit">Simpan Token</button>
      </form>
      <div id="tokenStatus" class="status"></div>
    </div>
    
    <!-- 2. Upload Logo (Header Profile) -->
    <div class="section">
      <h2>Upload Logo (Header Profile)</h2>
      <form id="uploadLogoForm">
        <label>Pilih file logo (akan disimpan sebagai logo/logo.png):</label>
        <input type="file" id="logoFile" accept="image/*" required>
        <button type="submit">Upload Logo</button>
      </form>
      <div id="uploadLogoStatus" class="status"></div>
    </div>
    
    <!-- 3. Upload Media (Foto/Video) ke Folder Images -->
    <div class="section">
      <h2>Upload Media (Foto/Video)</h2>
      <form id="uploadMediaForm">
        <label>Pilih file (foto/video):</label>
        <input type="file" id="mediaFile" accept="image/*,video/*" required>
        <button type="submit">Upload Media</button>
      </form>
      <div id="uploadMediaStatus" class="status"></div>
    </div>
    
    <!-- 4. Edit Member List (member_list.txt) -->
    <div class="section">
      <h2>Edit Member List</h2>
      <form id="editMemberForm">
        <label>Tambahkan data member (teks akan ditambahkan ke file):</label>
        <textarea id="memberText" rows="4" placeholder="Masukkan data member..."></textarea>
        <button type="submit">Simpan Perubahan</button>
      </form>
      <div id="memberStatus" class="status"></div>
    </div>
    
    <!-- 5. Edit Video Links (video_links.txt) -->
    <div class="section">
      <h2>Edit Video Links</h2>
      <form id="editVideoForm">
        <label>Masukkan link video baru (satu per baris):</label>
        <textarea id="videoText" rows="4" placeholder="Masukkan link video..."></textarea>
        <button type="submit">Simpan Perubahan</button>
      </form>
      <div id="videoStatus" class="status"></div>
    </div>
    
    <!-- 6. Edit Recruitment Link (recruitment.txt) -->
    <div class="section">
      <h2>Set Recruitment Link</h2>
      <form id="editRecruitmentForm">
        <label>Masukkan URL recruitment:</label>
        <input type="text" id="recruitmentInput" placeholder="Masukkan URL recruitment">
        <button type="submit">Simpan Perubahan</button>
      </form>
      <div id="recruitmentStatus" class="status"></div>
    </div>
    
    <!-- 7. Upload Minecraft Skin & Edit Skin List (skins_list.txt) -->
    <div class="section">
      <h2>Upload Minecraft Skin & Update Skin Mapping</h2>
      <form id="uploadSkinForm">
        <label>Pilih file skin Minecraft:</label>
        <input type="file" id="skinFile" accept="image/*" required>
        <label>Nama Player:</label>
        <input type="text" id="skinPlayer" placeholder="Masukkan nama player" required>
        <button type="submit">Upload Skin</button>
      </form>
      <div id="skinStatus" class="status"></div>
    </div>
  </div>
  
  <script>
    // Global Variabel
    let GITHUB_TOKEN = localStorage.getItem("GITHUB_TOKEN") || "";
    const OWNER = "ScarilyId";
    const REPO = "Darkhorn";
    
    const tokenStatus = document.getElementById("tokenStatus");
    function updateTokenStatus() {
      tokenStatus.textContent = GITHUB_TOKEN ? "Token tersimpan." : "Token belum diset.";
    }
    updateTokenStatus();
    
    // Simpan token
    document.getElementById("tokenForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const tokenInput = document.getElementById("tokenInput").value.trim();
      if(tokenInput) {
        GITHUB_TOKEN = tokenInput;
        localStorage.setItem("GITHUB_TOKEN", tokenInput);
        updateTokenStatus();
        alert("Token berhasil disimpan!");
      }
    });
    
    // Fungsi bantu: baca file sebagai Base64
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
    
    // Fungsi bantu: upload file ke GitHub
    async function uploadFileToGitHub(repo, path, file, commitMessage) {
      if(!GITHUB_TOKEN) {
        alert("Token GitHub belum diset!");
        return false;
      }
      try {
        const content = await readFileAsBase64(file);
        const url = `https://api.github.com/repos/${OWNER}/${repo}/contents/${path}`;
        let sha = null;
        const getResponse = await fetch(url, {
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        if(getResponse.ok) {
          const getData = await getResponse.json();
          sha = getData.sha;
        }
        const payload = {
          message: commitMessage,
          content: content,
          branch: "main"
        };
        if(sha) payload.sha = sha;
        const response = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Content-Type": "application/json",
            "Accept": "application/vnd.github.v3+json"
          },
          body: JSON.stringify(payload)
        });
        if(response.ok) {
          return true;
        } else {
          console.error(await response.json());
          return false;
        }
      } catch(error) {
        console.error(error);
        return false;
      }
    }
    
    // 2. Upload Logo (disimpan sebagai logo/logo.png)
    document.getElementById("uploadLogoForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const file = document.getElementById("logoFile").files[0];
      const statusDiv = document.getElementById("uploadLogoStatus");
      if(file) {
        statusDiv.textContent = "Uploading logo...";
        const path = "logo/logo.png";
        const success = await uploadFileToGitHub(REPO, path, file, "Upload logo " + file.name);
        statusDiv.textContent = success ? "Logo berhasil diupload." : "Gagal upload logo.";
        document.getElementById("logoFile").value = "";
      }
    });
    
    // 3. Upload Media (Foto/Video) ke folder images/
    document.getElementById("uploadMediaForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const file = document.getElementById("mediaFile").files[0];
      const statusDiv = document.getElementById("uploadMediaStatus");
      if(file) {
        statusDiv.textContent = "Uploading media...";
        const path = "images/" + file.name;
        const success = await uploadFileToGitHub(REPO, path, file, "Upload media " + file.name);
        statusDiv.textContent = success ? "Media berhasil diupload." : "Gagal upload media.";
        document.getElementById("mediaFile").value = "";
      }
    });
    
    // 4. Edit Member List (tambahkan data ke member_list.txt)
    document.getElementById("editMemberForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const newText = document.getElementById("memberText").value;
      const statusDiv = document.getElementById("memberStatus");
      if(newText.trim() === "") {
        statusDiv.textContent = "Teks tidak boleh kosong.";
        return;
      }
      await updateTextFile("member_list.txt", newText, statusDiv);
      document.getElementById("memberText").value = "";
    });
    
    // 5. Edit Video Links (video_links.txt)
    document.getElementById("editVideoForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const newText = document.getElementById("videoText").value;
      const statusDiv = document.getElementById("videoStatus");
      if(newText.trim() === "") {
        statusDiv.textContent = "Teks tidak boleh kosong.";
        return;
      }
      await updateTextFile("video_links.txt", newText, statusDiv);
      document.getElementById("videoText").value = "";
    });
    
    // 6. Edit Recruitment Link (recruitment.txt)
    document.getElementById("editRecruitmentForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const newLink = document.getElementById("recruitmentInput").value;
      const statusDiv = document.getElementById("recruitmentStatus");
      if(newLink.trim() === "") {
        statusDiv.textContent = "Link tidak boleh kosong.";
        return;
      }
      await updateTextFile("recruitment.txt", newLink, statusDiv);
      document.getElementById("recruitmentInput").value = "";
    });
    
    // 7. Upload Minecraft Skin & Update Skin Mapping (skins_list.txt)
    document.getElementById("uploadSkinForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const file = document.getElementById("skinFile").files[0];
      const playerName = document.getElementById("skinPlayer").value.trim();
      const statusDiv = document.getElementById("skinStatus");
      if(!file || playerName === "") {
        statusDiv.textContent = "File dan nama player harus diisi.";
        return;
      }
      statusDiv.textContent = "Uploading skin...";
      // Simpan skin di folder "skins/" dengan nama: [playerName]_[namaFile]
      const path = "skins/" + playerName + "_" + file.name;
      const success = await uploadFileToGitHub(REPO, path, file, "Upload skin " + file.name);
      if(success) {
        // Update mapping di file skins_list.txt (format: playerName:URL_skin)
        await updateTextFile("skins_list.txt", `${playerName}:${path}`, statusDiv);
      } else {
        statusDiv.textContent = "Gagal upload skin.";
      }
      document.getElementById("skinFile").value = "";
      document.getElementById("skinPlayer").value = "";
    });
    
    // Fungsi untuk update file teks di GitHub
    async function updateTextFile(filePath, newText, statusElement) {
      if(!GITHUB_TOKEN) {
        statusElement.textContent = "Token GitHub belum diset!";
        return;
      }
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${filePath}`;
      let sha = null;
      let existingContent = "";
      statusElement.textContent = "Mengambil konten file...";
      try {
        const getResponse = await fetch(url, {
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Accept": "application/vnd.github.v3+json"
          }
        });
        if(getResponse.ok) {
          const data = await getResponse.json();
          sha = data.sha;
          existingContent = atob(data.content);
        }
        // Gabungkan teks baru dengan konten yang ada (dengan pemisah baris)
        const updatedContent = existingContent + "\n" + newText;
        const payload = {
          message: "Update " + filePath,
          content: btoa(updatedContent),
          branch: "main"
        };
        if(sha) payload.sha = sha;
        statusElement.textContent = "Mengupdate file...";
        const response = await fetch(url, {
          method: "PUT",
          headers: {
            "Authorization": "token " + GITHUB_TOKEN,
            "Content-Type": "application/json",
            "Accept": "application/vnd.github.v3+json"
          },
          body: JSON.stringify(payload)
        });
        if(response.ok) {
          statusElement.textContent = filePath + " berhasil diperbarui.";
        } else {
          statusElement.textContent = "Gagal memperbarui " + filePath;
          console.error(await response.json());
        }
      } catch (error) {
        console.error(error);
        statusElement.textContent = "Error: " + error.message;
      }
    }
  </script>
</body>
</html>
